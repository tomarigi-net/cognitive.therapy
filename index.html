<script>
    async function analyzeThought() {
        // ここで 'thought' という名前で定義しています
        const thought = document.getElementById('user-thought').value;
        const belief = document.getElementById('belief-range').value;
        if (!thought) return alert('今の気持ちを入力してください');

        document.getElementById('input-section').classList.add('hidden');
        document.getElementById('loading').classList.remove('hidden');

        try {
            const response = await fetch('https://cognitive-therapy.onrender.com/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                // 変数名を 'thought' に修正しました
                body: JSON.stringify({ thought: thought })
            });

            if (!response.ok) throw new Error('サーバーでエラーが起きました');
            
            const data = await response.json();
            displayResults(data);

        } catch (error) {
            alert("エラーが発生しました: " + error.message);
            document.getElementById('input-section').classList.remove('hidden');
            document.getElementById('loading').classList.add('hidden');
        }
    }

    function displayResults(data) {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('result-section').classList.remove('hidden');

        // データの安全な読み込み
        const res = (typeof data === 'string') ? JSON.parse(data) : data;

        // 1. 認知の歪み
        const distList = document.getElementById('distortion-list');
        distList.innerHTML = '';
        (res.distortions || ["なし"]).forEach(d => {
            const span = document.createElement('span');
            span.className = 'distortion-tag';
            span.innerText = d;
            distList.appendChild(span);
        });

        // 2. 反論
        document.getElementById('refutation-text').innerText = res.refutation || '新しい視点が見つかりませんでした';

        // 3. メリット
        document.getElementById('benefit-text').innerText = res.benefit || '-';

        // 4. アクション
        const actionList = document.getElementById('action-list');
        actionList.innerHTML = '';
        (res.actions || []).forEach(a => {
            const li = document.createElement('li');
            li.innerText = a;
            actionList.appendChild(li);
        });
    }
</script>